function rcpBraintreeHandleError(e){let t=jQuery,n=t("#rcp_registration_form");t("#rcp-braintree-dropin-errors").empty().append('<div class="rcp_message error" role="list"><p class="rcp_error" role="listitem">'+e+"</p>"),n.length>0&&(n.unblock(),t("#rcp_submit").val(rcp_script_options.register)),rcp_processing=!1}jQuery(function(e){var t={dropinInstance:!1,hasCardDetails:!1,init:function(){e("body").on("rcp_gateway_loaded",t.mountUI),e("#rcp_submit").on("click",t.maybeBlockSubmit),e("body").on("rcp_registration_form_processed",t.tokenizePayment)},mountUI:function(n,r){document.getElementById("rcp-braintree-client-token")&&(rcp_braintree_script_options.dropin_ui_config.authorization=e("#rcp-braintree-client-token").val(),braintree.dropin.create(rcp_braintree_script_options.dropin_ui_config).then(function(e){t.dropinInstance=e,e.isPaymentMethodRequestable()&&(t.hasCardDetails=!0),e.on("paymentMethodRequestable",function(e){t.hasCardDetails=!0}),e.on("noPaymentMethodRequestable",function(e){t.hasCardDetails=!1})}).catch(function(e){rcpBraintreeHandleError(e)}))},maybeBlockSubmit:function(e){if("braintree"===rcp_get_gateway().val()&&document.getElementById("rcp-braintree-client-token")&&!t.hasCardDetails)return e.stopPropagation(),rcpBraintreeHandleError(rcp_script_options.enter_card_details),!1},tokenizePayment:function(n,r,i){if(!document.getElementById("rcp-braintree-client-token")||"braintree"!==rcp_get_gateway().val())return;let a=rcp_braintree_script_options.payment_method_options;void 0!==a.threeDSecure&&""===a.threeDSecure.email&&(a.threeDSecure.email=e("#rcp_user_email").val()),void 0!==a.threeDSecure&&void 0!==a.threeDSecure.additionalInformation&&""===a.threeDSecure.additionalInformation.deliveryEmail&&(a.threeDSecure.additionalInformation.deliveryEmail=e("#rcp_user_email").val()),void 0!==a.threeDSecure&&(a.threeDSecure.amount=i.total>0?i.total:i.recurring_total),t.dropinInstance.requestPaymentMethod(a).then(function(n){n.liabilityShiftPossible&&!n.liabilityShifted?(t.dropinInstance.clearSelectedPaymentMethod(),rcpBraintreeHandleError(rcp_braintree_script_options.try_new_payment)):(e(r).find("#rcp_submit_wrap").append('<input type="hidden" name="payment_method_nonce" value="'+n.nonce+'"/>'),rcp_submit_registration_form(r,i))}).catch(function(e){rcpBraintreeHandleError(e)})}};t.init();let n={container:!1,recurringAmount:0,hasCardDetails:!1,init:function(){n.container=e("#rcp_update_card_form"),n.container.length&&(n.mountUI(),n.container.on("submit",n.tokenizePayment))},mountUI:function(){if(!document.getElementById("rcp-braintree-client-token"))return;rcp_braintree_script_options.dropin_ui_config.authorization=e("#rcp-braintree-client-token").val();let t=rcp_braintree_script_options.dropin_ui_config;t.preselectVaultedPaymentMethod=!1,braintree.dropin.create(t).then(function(e){n.dropinInstance=e,e.isPaymentMethodRequestable()&&(n.hasCardDetails=!0),e.on("paymentMethodRequestable",function(e){n.hasCardDetails=!0}),e.on("noPaymentMethodRequestable",function(e){n.hasCardDetails=!1})}).catch(function(e){rcpBraintreeHandleError(e)})},disableButton:function(){let e=n.container.find("#rcp_submit");e.prop("disabled",!0).data("text",e.val()).val(rcp_braintree_script_options.please_wait)},enableButton:function(){let e=n.container.find("#rcp_submit");e.prop("disabled",!1).val(e.data("text"))},tokenizePayment:function(t){if(t.preventDefault(),!n.hasCardDetails)return rcpBraintreeHandleError(rcp_script_options.enter_card_details),!1;e("#rcp-braintree-dropin-errors").empty(),n.disableButton();let r=rcp_braintree_script_options.payment_method_options;r.threeDSecure.amount=e("#rcp-braintree-recurring-amount").val(),n.dropinInstance.requestPaymentMethod(r).then(function(e){if(e.liabilityShiftPossible&&!e.liabilityShifted)throw n.dropinInstance.clearSelectedPaymentMethod(),rcp_braintree_script_options.try_new_payment;n.container.append('<input type="hidden" name="payment_method_nonce" value="'+e.nonce+'"/>'),n.container.off("submit",n.tokenizePayment).submit()}).catch(function(e){return rcpBraintreeHandleError(e),n.enableButton(),!1})}};n.init()});
